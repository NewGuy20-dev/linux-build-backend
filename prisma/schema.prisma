datasource db {
  provider = "postgresql"
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

model UserBuild {
  id             String          @id @default(cuid())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  status         String          @default("PENDING")
  cancelledAt    DateTime?
  baseDistro     String
  spec           Json
  
  // Ownership for IDOR prevention
  ownerKey       String?         // API key hash or IP address
  
  // Multi-tenancy
  tenantId       String?
  tenant         Tenant?         @relation(fields: [tenantId], references: [id])
  
  // New fields for enhanced schema
  kernelVersion  String?
  initSystem     String?
  architecture   String?         @default("x86_64")
  securityLevel  String?         // minimal, standard, hardened
  featuresJson   Json?           // Full expanded spec with resolved packages
  buildDuration  Int?            // seconds
  warnings       String[]        @default([])
  
  logs           BuildLog[]
  artifacts      BuildArtifact[]

  @@index([status])
  @@index([ownerKey])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([tenantId])
}

model BuildLog {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  message   String
  level     String    @default("info") // info, warn, error
  build     UserBuild @relation(fields: [buildId], references: [id])
  buildId   String

  @@index([buildId])
  @@index([buildId, level])
}

model BuildArtifact {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  fileName  String
  fileType  String    // docker-image, docker-image-ref, iso, rootfs
  url       String
  size      BigInt?   // bytes
  checksum  String?   // sha256
  build     UserBuild @relation(fields: [buildId], references: [id])
  buildId   String

  @@index([buildId])
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  keyHash     String    @unique  // SHA-256 hash of the key
  keyPrefix   String              // First 8 chars for identification
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  revokedAt   DateTime?
  scopes      String[]  @default(["build:read", "build:write"])
  rateLimit   Int       @default(100)  // requests per minute
  metadata    Json?
  tenantId    String?
  tenant      Tenant?   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model Tenant {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  createdAt   DateTime  @default(now())
  tier        String    @default("free")  // free, standard, premium
  settings    Json?
  builds      UserBuild[]
  apiKeys     ApiKey[]
  webhooks    Webhook[]
}

model Webhook {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  url         String
  secret      String    // For HMAC signature
  events      String[]  @default(["build.completed", "build.failed"])
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  lastTriggeredAt DateTime?

  @@index([tenantId])
}

model ConversationContext {
  id          String    @id @default(cuid())
  sessionId   String    @unique
  messages    Json      @default("[]")
  buildSpec   Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expiresAt   DateTime

  @@index([sessionId])
}
