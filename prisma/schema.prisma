datasource db {
  provider = "postgresql"
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

model UserBuild {
  id             String          @id @default(cuid())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  status         String          @default("PENDING")
  cancelledAt    DateTime?
  baseDistro     String
  spec           Json
  
  // Ownership for IDOR prevention
  ownerKey       String?         // API key hash or IP address
  
  // Multi-tenancy
  tenantId       String?
  tenant         Tenant?         @relation(fields: [tenantId], references: [id])
  
  // New fields for enhanced schema
  kernelVersion  String?
  initSystem     String?
  architecture   String?         @default("x86_64")
  securityLevel  String?         // minimal, standard, hardened
  featuresJson   Json?           // Full expanded spec with resolved packages
  buildDuration  Int?            // seconds
  warnings       String[]        @default([])
  
  logs           BuildLog[]
  artifacts      BuildArtifact[]

  @@index([status])
  @@index([ownerKey])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([tenantId])
  @@index([ownerKey, status])
  @@index([tenantId, status, createdAt])
}

model BuildLog {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  message   String
  level     String    @default("info") // info, warn, error
  build     UserBuild @relation(fields: [buildId], references: [id])
  buildId   String

  @@index([buildId])
  @@index([buildId, level])
}

model BuildArtifact {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  fileName  String
  fileType  String    // docker-image, docker-image-ref, iso, rootfs
  url       String
  size      BigInt?   // bytes
  checksum  String?   // sha256
  build     UserBuild @relation(fields: [buildId], references: [id])
  buildId   String

  @@index([buildId])
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  keyHash     String    @unique  // SHA-256 hash of the key
  keyPrefix   String              // First 8 chars for identification
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  revokedAt   DateTime?
  scopes      String[]  @default(["build:read", "build:write"])
  rateLimit   Int       @default(100)  // requests per minute
  metadata    Json?
  tenantId    String?
  tenant      Tenant?   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model Tenant {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  createdAt   DateTime  @default(now())
  tier        String    @default("free")  // free, standard, premium
  settings    Json?
  
  // Phase 12: Resource quotas and usage
  maxBuildsPerMonth   Int       @default(100)
  maxConcurrentBuilds Int       @default(2)
  storageQuotaMb      Int       @default(5000)
  currentUsage        Json?     // { builds: 0, storageMb: 0 }
  
  builds      UserBuild[]
  apiKeys     ApiKey[]
  webhooks    Webhook[]
  teams       Team[]
  templates   BuildTemplate[]
  members     TenantMember[]
}

// Phase 12: RBAC - Tenant Members with Roles
model TenantMember {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  userId    String   // External user ID
  role      String   @default("member") // owner, admin, member, viewer
  createdAt DateTime @default(now())
  
  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
}

// Phase 13: Build Templates
model BuildTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  spec        Json
  version     String   @default("1.0.0")
  authorId    String
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  parentId    String?  // For forked templates
  downloads   Int      @default(0)
  rating      Float?
  tags        String[] @default([])
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  reviews     TemplateReview[]
  
  @@index([authorId])
  @@index([isPublic, rating])
  @@index([tenantId])
}

model TemplateReview {
  id         String   @id @default(cuid())
  templateId String
  template   BuildTemplate @relation(fields: [templateId], references: [id])
  userId     String
  rating     Int      // 1-5
  comment    String?
  createdAt  DateTime @default(now())
  
  @@unique([templateId, userId])
  @@index([templateId])
}

// Phase 14: Teams and Collaboration
model Team {
  id        String       @id @default(cuid())
  name      String
  slug      String       @unique
  tenantId  String
  tenant    Tenant       @relation(fields: [tenantId], references: [id])
  createdAt DateTime     @default(now())
  members   TeamMember[]
  approvals BuildApproval[]
  
  @@index([tenantId])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id])
  userId    String
  role      String   @default("viewer") // admin, builder, viewer
  createdAt DateTime @default(now())
  
  @@unique([teamId, userId])
  @@index([teamId])
}

model BuildApproval {
  id         String   @id @default(cuid())
  buildId    String
  teamId     String
  team       Team     @relation(fields: [teamId], references: [id])
  status     String   @default("pending") // pending, approved, rejected
  reviewerId String?
  comment    String?
  createdAt  DateTime @default(now())
  
  @@index([buildId])
  @@index([teamId])
}

// Phase 16: Analytics
model BuildMetrics {
  id            String   @id @default(cuid())
  buildId       String   @unique
  distro        String
  duration      Int      // seconds
  cpuSeconds    Float?
  memoryPeakMb  Int?
  diskUsageMb   Int?
  packageCount  Int?
  cacheHitRate  Float?
  status        String
  createdAt     DateTime @default(now())
  
  @@index([distro])
  @@index([createdAt])
  @@index([status])
}

// Phase 17: Security Scanning
model SecurityScan {
  id           String   @id @default(cuid())
  buildId      String
  scanType     String   // sbom, vulnerability, compliance
  status       String   @default("pending") // pending, completed, failed
  results      Json?
  vulnerabilities Int   @default(0)
  critical     Int      @default(0)
  high         Int      @default(0)
  medium       Int      @default(0)
  low          Int      @default(0)
  createdAt    DateTime @default(now())
  
  @@index([buildId])
  @@index([scanType])
}

// Phase 20: Plugin System
model Plugin {
  id          String   @id @default(cuid())
  name        String   @unique
  version     String
  description String?
  author      String
  entryPoint  String   // Path to plugin entry
  hooks       String[] @default([]) // preBuild, postBuild, etc.
  enabled     Boolean  @default(true)
  config      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([enabled])
}

// Phase 22: Maintenance Jobs
model MaintenanceJob {
  id          String    @id @default(cuid())
  type        String    // cleanup, backup, healthcheck
  status      String    @default("pending") // pending, running, completed, failed
  startedAt   DateTime?
  completedAt DateTime?
  result      Json?
  error       String?
  createdAt   DateTime  @default(now())
  
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Webhook {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  url         String
  secret      String    // For HMAC signature
  events      String[]  @default(["build.completed", "build.failed"])
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  lastTriggeredAt DateTime?

  @@index([tenantId])
}

model ConversationContext {
  id          String    @id @default(cuid())
  sessionId   String    @unique
  messages    Json      @default("[]")
  buildSpec   Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expiresAt   DateTime

  @@index([sessionId])
}

// Phase 21: Custom RBAC Roles
model CustomRole {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  permissions String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

// Phase 21: Usage/Billing Records
model UsageRecord {
  id        String   @id @default(cuid())
  tenantId  String
  type      String   // build, storage, api_call, compliance_check
  quantity  Int
  unitCost  Float    // in cents
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, timestamp])
  @@index([type])
}
