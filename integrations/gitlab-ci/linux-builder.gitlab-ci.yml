# Linux Builder GitLab CI Component
# Include this in your .gitlab-ci.yml:
# include:
#   - remote: 'https://raw.githubusercontent.com/linuxbuilder/integrations/main/gitlab-ci/linux-builder.gitlab-ci.yml'

.linux-builder:
  image: node:20-alpine
  variables:
    LINUX_BUILDER_API_URL: "https://api.linuxbuilder.io"
    LINUX_BUILDER_SPEC_FILE: "build-spec.json"
    LINUX_BUILDER_TIMEOUT: "1800"
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Starting Linux Builder build..."
      
      # Start build
      RESPONSE=$(curl -s -X POST "${LINUX_BUILDER_API_URL}/api/build/start" \
        -H "Authorization: Bearer ${LINUX_BUILDER_API_KEY}" \
        -H "Content-Type: application/json" \
        -d @${LINUX_BUILDER_SPEC_FILE})
      
      BUILD_ID=$(echo "$RESPONSE" | jq -r '.buildId')
      
      if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
        echo "Failed to start build: $RESPONSE"
        exit 1
      fi
      
      echo "Build started: $BUILD_ID"
      echo "BUILD_ID=$BUILD_ID" >> build.env
      
      # Poll for completion
      ELAPSED=0
      while [ $ELAPSED -lt $LINUX_BUILDER_TIMEOUT ]; do
        STATUS_RESPONSE=$(curl -s "${LINUX_BUILDER_API_URL}/api/build/status/${BUILD_ID}" \
          -H "Authorization: Bearer ${LINUX_BUILDER_API_KEY}")
        
        STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')
        echo "Status: $STATUS (${ELAPSED}s elapsed)"
        
        if [ "$STATUS" = "SUCCESS" ] || [ "$STATUS" = "COMPLETED" ]; then
          echo "Build completed successfully!"
          
          # Extract download URLs
          DOCKER_IMAGE=$(echo "$STATUS_RESPONSE" | jq -r '.downloadUrls.dockerImage // empty')
          ISO_URL=$(echo "$STATUS_RESPONSE" | jq -r '.downloadUrls.isoDownloadUrl // empty')
          
          [ -n "$DOCKER_IMAGE" ] && echo "DOCKER_IMAGE=$DOCKER_IMAGE" >> build.env
          [ -n "$ISO_URL" ] && echo "ISO_URL=${LINUX_BUILDER_API_URL}${ISO_URL}" >> build.env
          
          exit 0
        fi
        
        if [ "$STATUS" = "FAILED" ]; then
          echo "Build failed!"
          exit 1
        fi
        
        if [ "$STATUS" = "CANCELLED" ]; then
          echo "Build was cancelled"
          exit 1
        fi
        
        sleep 10
        ELAPSED=$((ELAPSED + 10))
      done
      
      echo "Build timed out after ${LINUX_BUILDER_TIMEOUT}s"
      exit 1
  artifacts:
    reports:
      dotenv: build.env

# Example job using the template
linux-build:
  extends: .linux-builder
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
